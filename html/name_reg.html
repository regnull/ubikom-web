<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="default.css" >
        <link rel="icon" 
            type="image/png" 
            href="favicon.png">
    </head>
    </style>
    <body>
    </p>
    <h1>Check Name Registration</h1>
    
    <p style="font-weight: bold;" id="network"></p>
    <form id="name-form">
        <input type="text" id="identifier" placeholder="identifier (i.e. bob)"/>
        <button name="submit" id="nextButton">Details</button>
        <i><p id="status" style="margin: 0"></p></i>
    </form>
    <p><i>Identifier must be a single word, only letters, numbers and symbols "_" and "-" are allowed.</i></p>
    <script src ="scripts/common.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js" type="text/javascript"></script>
    <script>
        function submit(event) {
            event.preventDefault();
            if (!nextEnabled) {
                return;
            }
            sessionStorage.setItem('identifier', document.getElementById('identifier').value);
            location.href = 'password.html';
        }

        function setStatus(msg, color, opacity) {
            let status = document.getElementById("status");
            status.innerHTML = msg;
            status.style.color = color;
        }

        function clearStatus() {
            document.getElementById("status").innerHTML = " ";
        }

        function enableNext(enable) {
            if (enable) {
                document.getElementById('nextButton').style.opacity = 1.0;
                nextEnabled = true;
                return;
            }
            document.getElementById('nextButton').style.opacity = 0.6;
            nextEnabled = false;
        }

        async function nameChanged() {
            clearStatus();

            let idInput = document.getElementById("identifier");

            if(idInput.value.length < 3) {
                setStatus("name is too short", '#FF0000');
                enableNext(false);
                return;
            }
            nameRegistry.methods.lookupName(idInput.value.toLowerCase()).call(function (err, res) {
                console.log(res)
                if (err) {
                    setStatus(err, '#FF0000');
                    enableNext(false);
                    return
                }
                if (res.owner == "0x0000000000000000000000000000000000000000") {
                    setStatus("available!", '#3ADF00');
                    enableNext(true);
                } else {
                    setStatus(`owned by <a href='${getEtherscanAddressUrl(res.owner)}' target='_blank'>${res.owner}</a>, \
                       ${res.price == 0 ? 'not for sale' : 'for sale for res.price'}`, '#FF0000');
                    enableNext(false);
                }
            })
        }
        document.getElementById("network").innerHTML = `Using ${getNetworkName()}`;

        const web3 = new Web3(getInfuraUrl());
        const nameRegistry = new web3.eth.Contract(nameRegistryContractAbi, getContractAddress());

        let nextEnabled = false;

        let idInput = document.getElementById("identifier");
        idInput.onkeyup = nameChanged;
        enableNext(false);
        document.getElementById('nextButton').onclick = submit;
    </script>
    </body>
</html>
