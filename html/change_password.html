<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="default.css">
        <link rel="icon" 
            type="image/png" 
            href="https://ubikom.cc/favicon.png">
    </head>
    <body>
        <h1>Change password</h1>
        <p>Here, you can change the password your mail client uses for SMTP/POP3 login. Please note, this will only work with 
            the users who do not use the master key (this includes users who registered online since October, 2021). 
            If your identity page listed email key and the private key, this way to change password won't work for you.
        </p>
        <form onSubmit={this.handleSubmit}>
            <input id="name" type="text" minlength="3" placeholder="identifier (i.e. bob)" style="display:block"/>
            <input id="password" type ='password' minlength="6" placeholder="old password" />
            <input id="password1" type='password' minlength="6" placeholder="new password" style="display: block;"/>
            <input id="password2" type='password' minlength="6" placeholder="confirm new password"/>
            <button name="submit" id="nextButton">Change password</button>
            <i><p id="status" style="margin: 0"></p></i>
        </form>
        <script>
            let nameInput = document.getElementById('name')
            let passwordInput = document.getElementById('password')
            let password1Input = document.getElementById('password1')
            let password2Input = document.getElementById('password2')
            let status = document.getElementById('status')
            let nextButton = document.getElementById('nextButton')
            let nextEnabled = false;
            
            function handleSubmit() {
                console.log('submitted!');
            }

            function passwordChanged() {
                updateNextButton();

                if(passwordInput.value.length < 6) {
                    status.innerHTML = "Password is too short";
                    status.style.color = '#FF0000';
                } else {
                    status.innerHTML = "";
                }
            }

            function password1Changed() {
                updateNextButton();

                if(password1Input.value.length < 6) {
                    status.innerHTML = "Password is too short";
                    status.style.color = '#FF0000';
                } else {
                    if (password2Input.value.length > 0 && password2Input.value != password1Input.value) {
                        status.innerHTML = "Passwords don't match";
                        status.style.color = '#FF0000';
                    } else {
                        status.innerHTML = "";
                    }
                }
            }

            function password2Changed() {
                updateNextButton();

                if(password2Input.value != password1Input.value) {
                    status.innerHTML = "Passwords don't match";
                    status.style.color = '#FF0000';
                } else {
                    status.innerHTML = "";
                }
            }

            function updateNextButton() {
                if (nameInput.value.length < 3 || passwordInput.value.length < 6 || password1Input.value.length < 6 || 
                    password2Input.value.length < 6 || password1Input.value != password2Input.value) {
                    nextButton.style.opacity = 0.6;
                    nextEnabled = false;
                } else {
                    nextButton.style.opacity = 1.0;
                    nextEnabled = true;
                }
            }

            function submit() {
                event.preventDefault();
                if (!nextEnabled) {
                    return;
                }
                let req = new XMLHttpRequest();
                req.onload = function () {
                    console.log('got result');
                    if (req.status == 200) {
                        status.innerHTML = "Password changed successfully";
                        status.style.color = '#3ADF00';
                    } else {
                        status.innerHTML = "Failed to change password, make sure the input is correct.";
                        status.style.color = '#FF0000';
                    }
                }
                req.open('POST', 'https://alpha.ubikom.cc:8088/changePassword', true);
                req.setRequestHeader('Content-Type', 'application/json');
                console.log('sending request');
                req.send(JSON.stringify({
                    "name": nameInput.value,
                    "password": passwordInput.value,
                    "new_password" : password1Input.value,
                }));
                nextButton.style.opacity = 0.6;
                nextEnabled = false;
            }
            
            passwordInput.onkeyup = passwordChanged
            password1Input.onkeyup = password1Changed;
            password2Input.onkeyup = password2Changed;
            nextButton.onclick = submit;

            updateNextButton();
        </script>
    </body>
</html>