<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../default.css">
        <link rel="icon" 
            type="image/png" 
            href="https://ubikom.cc/favicon.png">
    </head>
    <body>
        <h1 id="subject"></h1>
        <p id="from"></p>
        <p id="to"></p>
        <p id="cc"></p>
        <p id="bcc"></p>
        <p id="date"></p>
        <pre id="content"></pre>
        <script>
            let subject = document.getElementById("subject");
            let from = document.getElementById("from")
            let to = document.getElementById("to")
            let cc = document.getElementById("cc")
            let bcc = document.getElementById("bcc")
            let date = document.getElementById("date") 
            let content = document.getElementById("content");

            let token = sessionStorage.getItem('token');
            if (token == "") {
                location.href="login.html";
            }

            var queryString = location.search.substring(1);
            var parts = queryString.split("=");
            uid = parts[1];

            let req = new XMLHttpRequest();
            req.onload = function () {
                if (req.status == 200) {
                    let res = JSON.parse(req.responseText);
                    from.innerHTML = formatAddress(res.From);
                    to.innerHTML = formatAddressList(res.To);
                    if (res.Cc) {
                        cc.innerHTML = formatAddressList(res.Cc);
                    }
                    if (res.Bcc) {
                        bcc.innerHTML = formatAddressList(res.Bcc);
                    }
                    subject.innerHTML = res.Subject;
                    let d = new Date(res.Date)
                    date.innerHTML = d.toLocaleString();
                    content.innerHTML = res.Body;
                } else {
                    // TODO: Process error.
                }
            }
            req.open('GET', 'https://alpha.ubikom.cc:8899/message?uid=' + uid, true);
            req.setRequestHeader('Authorization', 'Bearer ' + token);
            console.log('sending request');
            req.send();

            function formatAddress(f) {
                return f.Name + " (" + f.Address + ")";
            }

            function formatAddressList(l) {
                let r = "";
                for (let i = 0; i < l.length; i++) {
                    let addr = l[i];
                    if (r != "") {
                        r += ", ";
                    }
                    r += formatAddress(addr)
                }
                return r
            }
        </script>
    </body>
</html>
