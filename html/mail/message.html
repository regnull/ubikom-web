<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="default.css">
        <link rel="icon" 
            type="image/png" 
            href="https://ubikom.cc/favicon.png">
    </head>
    <body class="messageBody">
        <h1 id="subject"></h1>
        <p>From: <span id="from" class="messageFrom"></span></p>
        <p>To: <span id="to" class="messageTo"></span></p>
        <p id="cc"></p>
        <p id="bcc"></p>
        <p id="date"></p>
        <p><a id="reply" class="messageAction">Reply</a> 
            <a id="replyAll" class="messageAction">Reply All</a>
            <a id="forward" class="messageAction">Forward</a>
            <a id="viewAsHTML" class="messageAction">View as HTML</a>
            <a id="delete" class="deleteAction" style="text-decoration: underline; cursor: pointer;">Delete</a></p>
        <pre id="content"></pre>
        <script type="text/javascript" src="common.js"></script>
        <script>
            let subject = document.getElementById("subject");
            let from = document.getElementById("from")
            let to = document.getElementById("to")
            let cc = document.getElementById("cc")
            let bcc = document.getElementById("bcc")
            let date = document.getElementById("date") 
            let content = document.getElementById("content");
            let reply = document.getElementById("reply");
            let replyAll = document.getElementById("replyAll");
            let forward = document.getElementById("forward");
            let viewAsHTML = document.getElementById("viewAsHTML")
            let deleteMessage = document.getElementById("delete")

            let token = sessionStorage.getItem(TOKEN_NAME);
            if (token == "") {
                location.href="login.html";
            }

            var queryString = location.search.substring(1);
            var parts = queryString.split("=");
            uid = parts[1];

            reply.href = "send.html?reply=" + uid;
            replyAll.href = "send.html?reply-all=" + uid;
            forward.href = "send.html?forward=" + uid;
            viewAsHTML.href = "html-message.html?uid=" + uid;

            deleteMessage.onclick = function () {
                let req = new XMLHttpRequest();
                req.onload = function () {
                if (req.status == 200) {
                        location.href = "inbox.html";
                    } else if (req.status == 401 || req.status == 403) {
                        location.href = "login.html";
                    } else {
                        // TODO: Process error.
                    }
                }
                req.open('GET', DELETE_URL +  '?uid=' + uid, true);
                req.setRequestHeader('Authorization', 'Bearer ' + token);
                console.log('sending request');
                req.send();
            };

            let req = new XMLHttpRequest();
            req.onload = function () {
                if (req.status == 200) {
                    let res = JSON.parse(req.responseText);
                    from.innerHTML = formatAddress(res.From);
                    to.innerHTML = formatAddressList(res.To);
                    if (res.Cc) {
                        cc.innerHTML = formatAddressList(res.Cc);
                    }
                    if (res.Bcc) {
                        bcc.innerHTML = formatAddressList(res.Bcc);
                    }
                    subject.innerHTML = res.Subject;
                    let d = new Date(res.Date)
                    date.innerHTML = d.toLocaleString();
                    content.innerHTML = res.Body;
                } else if (req.status == 401 || req.status == 403) {
                    location.href = "login.html";
                } else {
                    // TODO: Process error.
                }
            }
            req.open('GET', MESSAGE_URL +  '?uid=' + uid, true);
            req.setRequestHeader('Authorization', 'Bearer ' + token);
            console.log('sending request');
            req.send();
        </script>
    </body>
</html>
